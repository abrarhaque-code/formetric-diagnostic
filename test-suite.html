<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formetric Diagnostic Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Analytics 4 for testing -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    
    <style>
        .test-pass { color: #10B981; }
        .test-fail { color: #DC2626; }
        .test-warning { color: #F59E0B; }
        .test-info { color: #2563EB; }
        .performance-chart {
            height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Formetric Diagnostic Test Suite</h1>
        
        <div id="test-results" class="space-y-6">
            <!-- Test results will be populated here -->
        </div>
        
        <!-- Monitoring Dashboard -->
        <div id="monitoring-dashboard" class="bg-white rounded-lg p-6 shadow mb-8">
            <h2 class="text-xl font-bold mb-4">Live Monitoring Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-2xl font-bold text-blue-600" id="error-count">0</div>
                    <div class="text-sm text-gray-600">JavaScript Errors</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-2xl font-bold text-green-600" id="page-loads">0</div>
                    <div class="text-sm text-gray-600">Page Loads</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-2xl font-bold text-purple-600" id="diagnostic-starts">0</div>
                    <div class="text-sm text-gray-600">Diagnostic Starts</div>
                </div>
            </div>
            <div id="performance-metrics" class="performance-chart bg-gray-50 rounded">
                <div class="text-center text-gray-500">Performance metrics will display here</div>
            </div>
        </div>

        <div class="mt-8 flex flex-wrap gap-4">
            <button id="run-tests" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium">
                Run Complete Test Suite
            </button>
            <button id="test-user-journey" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium">
                Test User Journey
            </button>
            <button id="test-analytics" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium">
                Test Analytics
            </button>
            <button id="test-accessibility" class="bg-orange-600 text-white px-6 py-3 rounded-lg font-medium">
                Test Accessibility
            </button>
            <button id="performance-audit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium">
                Performance Audit
            </button>
            <button id="clear-logs" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                Clear Logs
            </button>
        </div>
    </div>

    <!-- Load the actual services for testing -->
    <script src="fallbacks.js"></script>
    <script src="supabase-client.js"></script>
    <script src="email-service.js"></script>

    <script>
        class DiagnosticTestSuite {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            addTest(name, testFn, category = 'general') {
                this.tests.push({ name, testFn, category });
            }

            async runAllTests() {
                this.results = [];
                const resultsContainer = document.getElementById('test-results');
                resultsContainer.innerHTML = '<div class="text-blue-600">Running tests...</div>';

                for (const test of this.tests) {
                    try {
                        const result = await test.testFn();
                        this.results.push({
                            name: test.name,
                            category: test.category,
                            status: result.status,
                            message: result.message,
                            details: result.details
                        });
                    } catch (error) {
                        this.results.push({
                            name: test.name,
                            category: test.category,
                            status: 'fail',
                            message: `Test failed: ${error.message}`,
                            details: error.stack
                        });
                    }
                }

                this.displayResults();
            }

            displayResults() {
                const resultsContainer = document.getElementById('test-results');
                const categories = [...new Set(this.results.map(r => r.category))];

                let html = '';
                categories.forEach(category => {
                    const categoryResults = this.results.filter(r => r.category === category);
                    const passCount = categoryResults.filter(r => r.status === 'pass').length;
                    const totalCount = categoryResults.length;

                    html += `
                        <div class="bg-white rounded-lg p-6 shadow">
                            <h2 class="text-xl font-bold mb-4 capitalize">${category} Tests (${passCount}/${totalCount})</h2>
                            <div class="space-y-2">
                    `;

                    categoryResults.forEach(result => {
                        const statusClass = result.status === 'pass' ? 'test-pass' : 
                                          result.status === 'fail' ? 'test-fail' :
                                          result.status === 'warning' ? 'test-warning' : 'test-info';
                        
                        html += `
                            <div class="border-l-4 ${result.status === 'pass' ? 'border-green-500' : 
                                                     result.status === 'fail' ? 'border-red-500' :
                                                     result.status === 'warning' ? 'border-yellow-500' : 'border-blue-500'} 
                                     pl-4 py-2">
                                <div class="flex items-center gap-2">
                                    <span class="${statusClass} font-medium">${result.status.toUpperCase()}</span>
                                    <span class="font-medium">${result.name}</span>
                                </div>
                                <div class="text-gray-600 text-sm mt-1">${result.message}</div>
                                ${result.details ? `<details class="text-xs text-gray-500 mt-1">
                                    <summary>Details</summary>
                                    <pre class="mt-1 whitespace-pre-wrap">${result.details}</pre>
                                </details>` : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;
            }

            // Test implementations
            async testLocalStorageSupport() {
                try {
                    const testKey = 'formetric_test';
                    localStorage.setItem(testKey, 'test_value');
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    
                    if (retrieved === 'test_value') {
                        return { 
                            status: 'pass', 
                            message: 'localStorage is available and working' 
                        };
                    } else {
                        return { 
                            status: 'fail', 
                            message: 'localStorage write/read failed' 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'fail', 
                        message: 'localStorage not available - privacy mode or disabled',
                        details: 'Will need to implement server-side session storage fallback'
                    };
                }
            }

            async testDiagnosticFormValidation() {
                try {
                    // Test the diagnostic form validation logic
                    const mockResponses = {
                        company_name: 'Test Company',
                        founder_name: 'John Doe',
                        email: 'john@testcompany.com',
                        industry_focus: 'supplements',
                        revenue_range: '500k_1m'
                    };

                    // Test scoring algorithm
                    const score = this.calculateMockScore(mockResponses);
                    
                    if (score >= 35 && score <= 92) {
                        return {
                            status: 'pass',
                            message: `Scoring algorithm produces valid range: ${score}`,
                            details: 'Score range validation passed'
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: `Score out of valid range: ${score}`,
                            details: 'Scoring algorithm needs adjustment'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Scoring algorithm failed',
                        details: error.message
                    };
                }
            }

            calculateMockScore(responses) {
                // Replicate the scoring logic from results.js for testing
                let baseScore = 45;
                
                const revenueScores = {
                    'pre_revenue': 15,
                    '0_100k': 25,
                    '100k_500k': 35,
                    '500k_1m': 50,
                    '1m_5m': 70,
                    '5m_plus': 85
                };
                baseScore += revenueScores[responses.revenue_range] || 0;

                return Math.max(35, Math.min(92, Math.round(baseScore)));
            }

            async testEmailValidation() {
                const validEmails = [
                    'test@example.com',
                    'user.name+tag@domain.co.uk',
                    'test123@test-domain.com'
                ];

                const invalidEmails = [
                    'invalid.email',
                    '@domain.com',
                    'test@',
                    ''
                ];

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                const validResults = validEmails.every(email => emailRegex.test(email));
                const invalidResults = invalidEmails.every(email => !emailRegex.test(email));

                if (validResults && invalidResults) {
                    return {
                        status: 'pass',
                        message: 'Email validation working correctly'
                    };
                } else {
                    return {
                        status: 'fail',
                        message: 'Email validation has issues',
                        details: `Valid emails: ${validResults}, Invalid emails: ${invalidResults}`
                    };
                }
            }

            async testMobileResponsiveness() {
                const viewportWidth = window.innerWidth;
                const isMobile = viewportWidth < 768;

                // Test if mobile-specific elements are present
                const mobileOptimizations = [];

                // Check if diagnostic form is mobile-optimized
                const diagnosticExists = document.querySelector('.diagnostic-card') !== null;
                if (!diagnosticExists) {
                    // Load diagnostic in iframe to test
                    return {
                        status: 'warning',
                        message: 'Mobile responsiveness needs manual testing',
                        details: 'Load diagnostic.html on mobile device to verify'
                    };
                }

                return {
                    status: 'info',
                    message: `Current viewport: ${viewportWidth}px ${isMobile ? '(Mobile)' : '(Desktop)'}`,
                    details: 'Test on actual mobile devices for complete validation'
                };
            }

            async testDataPersistence() {
                try {
                    const mockData = {
                        diagnosticResponses: { company_name: 'Test Co', email: 'test@example.com' },
                        diagnosticScore: { overall: 75 },
                        userEmail: 'test@example.com'
                    };

                    // Test localStorage persistence
                    Object.keys(mockData).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(mockData[key]));
                    });

                    // Verify retrieval
                    const allRetrieved = Object.keys(mockData).every(key => {
                        const retrieved = JSON.parse(localStorage.getItem(key) || '{}');
                        return JSON.stringify(retrieved) === JSON.stringify(mockData[key]);
                    });

                    // Cleanup
                    Object.keys(mockData).forEach(key => {
                        localStorage.removeItem(key);
                    });

                    if (allRetrieved) {
                        return {
                            status: 'pass',
                            message: 'Data persistence working correctly'
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Data persistence has issues'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Data persistence failed',
                        details: error.message
                    };
                }
            }

            async testSupabaseConnection() {
                try {
                    if (!window.supabaseClient) {
                        return {
                            status: 'fail',
                            message: 'Supabase client not loaded',
                            details: 'Make sure supabase-client.js is included'
                        };
                    }

                    // Test connection
                    const connectionTest = await window.supabaseClient.testConnection();
                    
                    if (connectionTest.success) {
                        return {
                            status: 'pass',
                            message: 'Supabase connection successful',
                            details: `Connected to: ${connectionTest.url?.substring(0, 30)}...`
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Supabase connection failed',
                            details: connectionTest.error
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Supabase test failed',
                        details: error.message
                    };
                }
            }

            async testEmailDelivery() {
                try {
                    if (!window.emailService) {
                        return {
                            status: 'fail',
                            message: 'Email service not loaded',
                            details: 'Make sure email-service.js is included'
                        };
                    }

                    // Check if email service is configured
                    if (!window.emailService.isConfigured) {
                        return {
                            status: 'warning',
                            message: 'Email service not configured',
                            details: 'Running in mock mode - replace YOUR_RESEND_API_KEY in email-service.js'
                        };
                    }

                    // Test email sending with mock data
                    const testEmailResult = await window.emailService.sendDiagnosticResults(
                        'test@formetric.com',
                        {
                            company_name: 'Test Company',
                            founder_name: 'Test User', 
                            email: 'test@formetric.com',
                            score: { overall: 75 },
                            databaseId: 'test-123'
                        }
                    );

                    if (testEmailResult.success) {
                        return {
                            status: 'pass',
                            message: testEmailResult.mock ? 'Email service ready (mock mode)' : 'Email sent successfully',
                            details: `Message ID: ${testEmailResult.messageId}`
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Email delivery failed',
                            details: testEmailResult.error
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Email test failed',
                        details: error.message
                    };
                }
            }

            async testPrivacyCompliance() {
                try {
                    const checks = [];
                    
                    // Check for privacy policy link
                    const privacyResponse = await fetch('./privacy-policy.html');
                    checks.push({
                        element: 'Privacy Policy Page',
                        exists: privacyResponse.ok,
                        details: privacyResponse.ok ? 'Accessible' : 'Missing or inaccessible'
                    });
                    
                    // Check for terms page
                    const termsResponse = await fetch('./terms.html');
                    checks.push({
                        element: 'Terms of Service Page',
                        exists: termsResponse.ok,
                        details: termsResponse.ok ? 'Accessible' : 'Missing or inaccessible'
                    });
                    
                    // Check diagnostic page for consent elements
                    const diagnosticResponse = await fetch('./diagnostic.html');
                    if (diagnosticResponse.ok) {
                        const diagnosticText = await diagnosticResponse.text();
                        checks.push({
                            element: 'Email Consent',
                            exists: diagnosticText.includes('email') && diagnosticText.includes('consent'),
                            details: 'Checking for email consent in diagnostic'
                        });
                        
                        checks.push({
                            element: 'Privacy Link in Diagnostic',
                            exists: diagnosticText.includes('privacy') || diagnosticText.includes('Privacy'),
                            details: 'Checking for privacy link in diagnostic flow'
                        });
                    }
                    
                    const failedChecks = checks.filter(check => !check.exists);
                    
                    if (failedChecks.length === 0) {
                        return {
                            status: 'pass',
                            message: 'All privacy compliance elements present',
                            details: checks.map(c => `${c.element}: ${c.details}`).join('\n')
                        };
                    } else {
                        return {
                            status: failedChecks.length < checks.length ? 'warning' : 'fail',
                            message: `${failedChecks.length}/${checks.length} privacy elements missing`,
                            details: checks.map(c => `${c.element}: ${c.exists ? '✓' : '✗'} ${c.details}`).join('\n')
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Privacy compliance test failed',
                        details: error.message
                    };
                }
            }

            async testGoogleAnalytics() {
                try {
                    // Check if GA is loaded
                    if (typeof gtag === 'undefined') {
                        return {
                            status: 'fail',
                            message: 'Google Analytics not loaded',
                            details: 'gtag function not found'
                        };
                    }
                    
                    // Test custom event tracking
                    let eventFired = false;
                    const originalGtag = window.gtag;
                    
                    // Override gtag to capture events
                    window.gtag = function(...args) {
                        if (args[0] === 'event') {
                            eventFired = true;
                        }
                        return originalGtag.apply(this, args);
                    };
                    
                    // Fire test event
                    gtag('event', 'test_event', {
                        event_category: 'test',
                        event_label: 'test_suite'
                    });
                    
                    // Restore original gtag
                    window.gtag = originalGtag;
                    
                    if (eventFired) {
                        return {
                            status: 'pass',
                            message: 'Google Analytics tracking functional',
                            details: 'Custom events can be tracked'
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Google Analytics event tracking failed',
                            details: 'Custom events not firing'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Google Analytics test failed',
                        details: error.message
                    };
                }
            }

            async testAccessibility() {
                const issues = [];
                
                try {
                    // Check for alt text on images
                    const images = document.querySelectorAll('img');
                    images.forEach((img, index) => {
                        if (!img.alt) {
                            issues.push(`Image ${index + 1} missing alt text`);
                        }
                    });
                    
                    // Check for proper heading hierarchy
                    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    let lastLevel = 0;
                    headings.forEach(heading => {
                        const level = parseInt(heading.tagName.charAt(1));
                        if (level > lastLevel + 1) {
                            issues.push(`Heading hierarchy skip: ${heading.tagName} after H${lastLevel}`);
                        }
                        lastLevel = level;
                    });
                    
                    // Check for form labels
                    const inputs = document.querySelectorAll('input, textarea, select');
                    inputs.forEach((input, index) => {
                        if (!input.labels || input.labels.length === 0) {
                            if (!input.getAttribute('aria-label') && !input.getAttribute('aria-labelledby')) {
                                issues.push(`Form element ${index + 1} missing label or aria-label`);
                            }
                        }
                    });
                    
                    // Check color contrast (basic check)
                    const contrastIssues = this.checkColorContrast();
                    issues.push(...contrastIssues);
                    
                    if (issues.length === 0) {
                        return {
                            status: 'pass',
                            message: 'No accessibility issues found',
                            details: 'Basic accessibility checks passed'
                        };
                    } else {
                        return {
                            status: issues.length > 5 ? 'fail' : 'warning',
                            message: `${issues.length} accessibility issues found`,
                            details: issues.join('\n')
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Accessibility test failed',
                        details: error.message
                    };
                }
            }

            checkColorContrast() {
                // Basic color contrast check
                const issues = [];
                const elements = document.querySelectorAll('*');
                
                elements.forEach(element => {
                    const styles = window.getComputedStyle(element);
                    const color = styles.color;
                    const backgroundColor = styles.backgroundColor;
                    
                    // Check if text is visible (not comprehensive, but basic check)
                    if (color === backgroundColor && color !== 'rgba(0, 0, 0, 0)') {
                        issues.push(`Potential contrast issue: ${element.tagName}`);
                    }
                });
                
                return issues.slice(0, 5); // Limit to 5 issues
            }

            async testPerformance() {
                try {
                    const navigationTiming = performance.getEntriesByType('navigation')[0];
                    const metrics = {};
                    
                    if (navigationTiming) {
                        metrics.domContentLoaded = Math.round(navigationTiming.domContentLoadedEventEnd - navigationTiming.navigationStart);
                        metrics.loadComplete = Math.round(navigationTiming.loadEventEnd - navigationTiming.navigationStart);
                        metrics.firstByte = Math.round(navigationTiming.responseStart - navigationTiming.navigationStart);
                    }
                    
                    // Test Core Web Vitals if available
                    if ('web-vitals' in window) {
                        // Web Vitals library is loaded
                        metrics.coreWebVitals = 'Available';
                    } else {
                        metrics.coreWebVitals = 'Not loaded';
                    }
                    
                    // Performance score calculation
                    let score = 100;
                    let issues = [];
                    
                    if (metrics.domContentLoaded > 2000) {
                        score -= 20;
                        issues.push('DOM Content Loaded > 2s');
                    }
                    
                    if (metrics.loadComplete > 4000) {
                        score -= 20;
                        issues.push('Load Complete > 4s');
                    }
                    
                    if (metrics.firstByte > 1000) {
                        score -= 10;
                        issues.push('First Byte > 1s');
                    }
                    
                    const status = score >= 80 ? 'pass' : score >= 60 ? 'warning' : 'fail';
                    
                    return {
                        status: status,
                        message: `Performance Score: ${score}/100`,
                        details: `DOM Ready: ${metrics.domContentLoaded}ms\nLoad Complete: ${metrics.loadComplete}ms\nFirst Byte: ${metrics.firstByte}ms\nIssues: ${issues.join(', ') || 'None'}`
                    };
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Performance test failed',
                        details: error.message
                    };
                }
            }

            async testEmailServerlessFunction() {
                try {
                    const testData = {
                        email: 'test@example.com',
                        results: {
                            company_name: 'Test Company',
                            score: { overall: 75 },
                            recommendations: ['Test recommendation']
                        }
                    };
                    
                    // Check if the serverless function endpoint exists
                    const response = await fetch('./api/send-email.js');
                    
                    if (response.ok) {
                        return {
                            status: 'pass',
                            message: 'Email serverless function exists',
                            details: 'Function file found and accessible'
                        };
                    } else {
                        return {
                            status: 'warning',
                            message: 'Email serverless function not accessible',
                            details: 'Function may not be deployed or properly configured'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Email serverless function test failed',
                        details: error.message
                    };
                }
            }

            async simulateUserJourney() {
                const steps = [];
                
                try {
                    // Step 1: Landing page to diagnostic
                    steps.push({ step: 'Landing → Diagnostic', status: 'pass', message: 'Navigation working' });
                    
                    // Step 2: Complete diagnostic form
                    const mockResponses = {
                        company_name: 'Test Wellness Co',
                        founder_name: 'Jane Smith',
                        email: 'jane@testwellness.com',
                        industry_focus: 'supplements',
                        revenue_range: '500k_1m',
                        primary_channel: 'dtc_online'
                    };
                    
                    localStorage.setItem('diagnosticResponses', JSON.stringify(mockResponses));
                    steps.push({ step: 'Form Completion', status: 'pass', message: 'Mock data stored' });
                    
                    // Step 3: Score calculation
                    const score = this.calculateMockScore(mockResponses);
                    localStorage.setItem('diagnosticScore', JSON.stringify({ overall: score }));
                    steps.push({ step: 'Score Calculation', status: 'pass', message: `Score: ${score}` });
                    
                    // Step 4: Results display
                    steps.push({ step: 'Results Display', status: 'pass', message: 'Results page ready' });
                    
                    // Step 5: Email capture
                    localStorage.setItem('userEmail', mockResponses.email);
                    steps.push({ step: 'Email Capture', status: 'pass', message: 'Email stored locally' });
                    
                    // Cleanup
                    ['diagnosticResponses', 'diagnosticScore', 'userEmail'].forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    return {
                        status: 'pass',
                        message: 'Complete user journey simulation successful',
                        details: steps.map(s => `${s.step}: ${s.message}`).join('\n')
                    };
                    
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'User journey simulation failed',
                        details: error.message
                    };
                }
            }
        }

        // Initialize test suite
        const testSuite = new DiagnosticTestSuite();

        // Error monitoring system
        let errorCount = 0;
        let pageLoads = 0;
        let diagnosticStarts = 0;
        
        // Global error handler
        window.addEventListener('error', (event) => {
            errorCount++;
            document.getElementById('error-count').textContent = errorCount;
            console.error('Monitored Error:', event.error);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            errorCount++;
            document.getElementById('error-count').textContent = errorCount;
            console.error('Monitored Promise Rejection:', event.reason);
        });
        
        // Performance monitoring
        function updatePerformanceMetrics() {
            const nav = performance.getEntriesByType('navigation')[0];
            if (nav) {
                const metricsHtml = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>DOM Ready:</strong> ${Math.round(nav.domContentLoadedEventEnd - nav.navigationStart)}ms</div>
                        <div><strong>Load Complete:</strong> ${Math.round(nav.loadEventEnd - nav.navigationStart)}ms</div>
                        <div><strong>First Byte:</strong> ${Math.round(nav.responseStart - nav.navigationStart)}ms</div>
                        <div><strong>DNS Lookup:</strong> ${Math.round(nav.domainLookupEnd - nav.domainLookupStart)}ms</div>
                    </div>
                `;
                document.getElementById('performance-metrics').innerHTML = metricsHtml;
            }
        }
        
        // Update performance metrics on load
        window.addEventListener('load', () => {
            pageLoads++;
            document.getElementById('page-loads').textContent = pageLoads;
            setTimeout(updatePerformanceMetrics, 100);
        });

        // Add all tests
        testSuite.addTest('localStorage Support', () => testSuite.testLocalStorageSupport(), 'infrastructure');
        testSuite.addTest('Diagnostic Form Validation', () => testSuite.testDiagnosticFormValidation(), 'functionality');
        testSuite.addTest('Email Validation', () => testSuite.testEmailValidation(), 'functionality');
        testSuite.addTest('Mobile Responsiveness', () => testSuite.testMobileResponsiveness(), 'ui-ux');
        testSuite.addTest('Data Persistence', () => testSuite.testDataPersistence(), 'functionality');
        testSuite.addTest('Supabase Connection', () => testSuite.testSupabaseConnection(), 'infrastructure');
        testSuite.addTest('Email Delivery', () => testSuite.testEmailDelivery(), 'infrastructure');
        testSuite.addTest('Privacy Compliance', () => testSuite.testPrivacyCompliance(), 'legal');
        testSuite.addTest('Google Analytics', () => testSuite.testGoogleAnalytics(), 'analytics');
        testSuite.addTest('Accessibility', () => testSuite.testAccessibility(), 'accessibility');
        testSuite.addTest('Performance Metrics', () => testSuite.testPerformance(), 'performance');
        testSuite.addTest('Email Serverless Function', () => testSuite.testEmailServerlessFunction(), 'infrastructure');

        // Event listeners
        document.getElementById('run-tests').addEventListener('click', () => {
            testSuite.runAllTests();
        });

        document.getElementById('test-user-journey').addEventListener('click', async () => {
            const result = await testSuite.simulateUserJourney();
            document.getElementById('test-results').innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">User Journey Test</h2>
                    <div class="border-l-4 ${result.status === 'pass' ? 'border-green-500' : 'border-red-500'} pl-4 py-2">
                        <div class="flex items-center gap-2">
                            <span class="${result.status === 'pass' ? 'test-pass' : 'test-fail'} font-medium">${result.status.toUpperCase()}</span>
                            <span class="font-medium">${result.message}</span>
                        </div>
                        <pre class="text-xs text-gray-500 mt-2 whitespace-pre-wrap">${result.details}</pre>
                    </div>
                </div>
            `;
        });

        // Additional event listeners for new buttons
        document.getElementById('test-analytics').addEventListener('click', async () => {
            const result = await testSuite.testGoogleAnalytics();
            testSuite.displaySingleResult('Google Analytics Test', result);
        });
        
        document.getElementById('test-accessibility').addEventListener('click', async () => {
            const result = await testSuite.testAccessibility();
            testSuite.displaySingleResult('Accessibility Test', result);
        });
        
        document.getElementById('performance-audit').addEventListener('click', async () => {
            const result = await testSuite.testPerformance();
            testSuite.displaySingleResult('Performance Audit', result);
        });
        
        document.getElementById('clear-logs').addEventListener('click', () => {
            errorCount = 0;
            document.getElementById('error-count').textContent = '0';
            console.clear();
        });
        
        // Helper method to display single test result
        testSuite.displaySingleResult = function(testName, result) {
            const statusClass = result.status === 'pass' ? 'test-pass' : 
                              result.status === 'fail' ? 'test-fail' :
                              result.status === 'warning' ? 'test-warning' : 'test-info';
            
            document.getElementById('test-results').innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">${testName}</h2>
                    <div class="border-l-4 ${result.status === 'pass' ? 'border-green-500' : 
                                              result.status === 'fail' ? 'border-red-500' :
                                              result.status === 'warning' ? 'border-yellow-500' : 'border-blue-500'} pl-4 py-2">
                        <div class="flex items-center gap-2">
                            <span class="${statusClass} font-medium">${result.status.toUpperCase()}</span>
                            <span class="font-medium">${result.message}</span>
                        </div>
                        ${result.details ? `<pre class="text-xs text-gray-500 mt-2 whitespace-pre-wrap">${result.details}</pre>` : ''}
                    </div>
                </div>
            `;
        };

        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                updatePerformanceMetrics();
                testSuite.runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>