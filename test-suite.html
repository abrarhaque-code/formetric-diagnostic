<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formetric Diagnostic Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-pass { color: #10B981; }
        .test-fail { color: #DC2626; }
        .test-warning { color: #F59E0B; }
        .test-info { color: #2563EB; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Formetric Diagnostic Test Suite</h1>
        
        <div id="test-results" class="space-y-6">
            <!-- Test results will be populated here -->
        </div>
        
        <div class="mt-8">
            <button id="run-tests" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium">
                Run Complete Test Suite
            </button>
            <button id="test-user-journey" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium ml-4">
                Test User Journey
            </button>
        </div>
    </div>

    <!-- Load the actual services for testing -->
    <script src="fallbacks.js"></script>
    <script src="supabase-client.js"></script>
    <script src="email-service.js"></script>

    <script>
        class DiagnosticTestSuite {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            addTest(name, testFn, category = 'general') {
                this.tests.push({ name, testFn, category });
            }

            async runAllTests() {
                this.results = [];
                const resultsContainer = document.getElementById('test-results');
                resultsContainer.innerHTML = '<div class="text-blue-600">Running tests...</div>';

                for (const test of this.tests) {
                    try {
                        const result = await test.testFn();
                        this.results.push({
                            name: test.name,
                            category: test.category,
                            status: result.status,
                            message: result.message,
                            details: result.details
                        });
                    } catch (error) {
                        this.results.push({
                            name: test.name,
                            category: test.category,
                            status: 'fail',
                            message: `Test failed: ${error.message}`,
                            details: error.stack
                        });
                    }
                }

                this.displayResults();
            }

            displayResults() {
                const resultsContainer = document.getElementById('test-results');
                const categories = [...new Set(this.results.map(r => r.category))];

                let html = '';
                categories.forEach(category => {
                    const categoryResults = this.results.filter(r => r.category === category);
                    const passCount = categoryResults.filter(r => r.status === 'pass').length;
                    const totalCount = categoryResults.length;

                    html += `
                        <div class="bg-white rounded-lg p-6 shadow">
                            <h2 class="text-xl font-bold mb-4 capitalize">${category} Tests (${passCount}/${totalCount})</h2>
                            <div class="space-y-2">
                    `;

                    categoryResults.forEach(result => {
                        const statusClass = result.status === 'pass' ? 'test-pass' : 
                                          result.status === 'fail' ? 'test-fail' :
                                          result.status === 'warning' ? 'test-warning' : 'test-info';
                        
                        html += `
                            <div class="border-l-4 ${result.status === 'pass' ? 'border-green-500' : 
                                                     result.status === 'fail' ? 'border-red-500' :
                                                     result.status === 'warning' ? 'border-yellow-500' : 'border-blue-500'} 
                                     pl-4 py-2">
                                <div class="flex items-center gap-2">
                                    <span class="${statusClass} font-medium">${result.status.toUpperCase()}</span>
                                    <span class="font-medium">${result.name}</span>
                                </div>
                                <div class="text-gray-600 text-sm mt-1">${result.message}</div>
                                ${result.details ? `<details class="text-xs text-gray-500 mt-1">
                                    <summary>Details</summary>
                                    <pre class="mt-1 whitespace-pre-wrap">${result.details}</pre>
                                </details>` : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;
            }

            // Test implementations
            async testLocalStorageSupport() {
                try {
                    const testKey = 'formetric_test';
                    localStorage.setItem(testKey, 'test_value');
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    
                    if (retrieved === 'test_value') {
                        return { 
                            status: 'pass', 
                            message: 'localStorage is available and working' 
                        };
                    } else {
                        return { 
                            status: 'fail', 
                            message: 'localStorage write/read failed' 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'fail', 
                        message: 'localStorage not available - privacy mode or disabled',
                        details: 'Will need to implement server-side session storage fallback'
                    };
                }
            }

            async testDiagnosticFormValidation() {
                try {
                    // Test the diagnostic form validation logic
                    const mockResponses = {
                        company_name: 'Test Company',
                        founder_name: 'John Doe',
                        email: 'john@testcompany.com',
                        industry_focus: 'supplements',
                        revenue_range: '500k_1m'
                    };

                    // Test scoring algorithm
                    const score = this.calculateMockScore(mockResponses);
                    
                    if (score >= 35 && score <= 92) {
                        return {
                            status: 'pass',
                            message: `Scoring algorithm produces valid range: ${score}`,
                            details: 'Score range validation passed'
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: `Score out of valid range: ${score}`,
                            details: 'Scoring algorithm needs adjustment'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Scoring algorithm failed',
                        details: error.message
                    };
                }
            }

            calculateMockScore(responses) {
                // Replicate the scoring logic from results.js for testing
                let baseScore = 45;
                
                const revenueScores = {
                    'pre_revenue': 15,
                    '0_100k': 25,
                    '100k_500k': 35,
                    '500k_1m': 50,
                    '1m_5m': 70,
                    '5m_plus': 85
                };
                baseScore += revenueScores[responses.revenue_range] || 0;

                return Math.max(35, Math.min(92, Math.round(baseScore)));
            }

            async testEmailValidation() {
                const validEmails = [
                    'test@example.com',
                    'user.name+tag@domain.co.uk',
                    'test123@test-domain.com'
                ];

                const invalidEmails = [
                    'invalid.email',
                    '@domain.com',
                    'test@',
                    ''
                ];

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                const validResults = validEmails.every(email => emailRegex.test(email));
                const invalidResults = invalidEmails.every(email => !emailRegex.test(email));

                if (validResults && invalidResults) {
                    return {
                        status: 'pass',
                        message: 'Email validation working correctly'
                    };
                } else {
                    return {
                        status: 'fail',
                        message: 'Email validation has issues',
                        details: `Valid emails: ${validResults}, Invalid emails: ${invalidResults}`
                    };
                }
            }

            async testMobileResponsiveness() {
                const viewportWidth = window.innerWidth;
                const isMobile = viewportWidth < 768;

                // Test if mobile-specific elements are present
                const mobileOptimizations = [];

                // Check if diagnostic form is mobile-optimized
                const diagnosticExists = document.querySelector('.diagnostic-card') !== null;
                if (!diagnosticExists) {
                    // Load diagnostic in iframe to test
                    return {
                        status: 'warning',
                        message: 'Mobile responsiveness needs manual testing',
                        details: 'Load diagnostic.html on mobile device to verify'
                    };
                }

                return {
                    status: 'info',
                    message: `Current viewport: ${viewportWidth}px ${isMobile ? '(Mobile)' : '(Desktop)'}`,
                    details: 'Test on actual mobile devices for complete validation'
                };
            }

            async testDataPersistence() {
                try {
                    const mockData = {
                        diagnosticResponses: { company_name: 'Test Co', email: 'test@example.com' },
                        diagnosticScore: { overall: 75 },
                        userEmail: 'test@example.com'
                    };

                    // Test localStorage persistence
                    Object.keys(mockData).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(mockData[key]));
                    });

                    // Verify retrieval
                    const allRetrieved = Object.keys(mockData).every(key => {
                        const retrieved = JSON.parse(localStorage.getItem(key) || '{}');
                        return JSON.stringify(retrieved) === JSON.stringify(mockData[key]);
                    });

                    // Cleanup
                    Object.keys(mockData).forEach(key => {
                        localStorage.removeItem(key);
                    });

                    if (allRetrieved) {
                        return {
                            status: 'pass',
                            message: 'Data persistence working correctly'
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Data persistence has issues'
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Data persistence failed',
                        details: error.message
                    };
                }
            }

            async testSupabaseConnection() {
                try {
                    if (!window.supabaseClient) {
                        return {
                            status: 'fail',
                            message: 'Supabase client not loaded',
                            details: 'Make sure supabase-client.js is included'
                        };
                    }

                    // Test connection
                    const connectionTest = await window.supabaseClient.testConnection();
                    
                    if (connectionTest.success) {
                        return {
                            status: 'pass',
                            message: 'Supabase connection successful',
                            details: `Connected to: ${connectionTest.url?.substring(0, 30)}...`
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Supabase connection failed',
                            details: connectionTest.error
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Supabase test failed',
                        details: error.message
                    };
                }
            }

            async testEmailDelivery() {
                try {
                    if (!window.emailService) {
                        return {
                            status: 'fail',
                            message: 'Email service not loaded',
                            details: 'Make sure email-service.js is included'
                        };
                    }

                    // Check if email service is configured
                    if (!window.emailService.isConfigured) {
                        return {
                            status: 'warning',
                            message: 'Email service not configured',
                            details: 'Running in mock mode - replace YOUR_RESEND_API_KEY in email-service.js'
                        };
                    }

                    // Test email sending with mock data
                    const testEmailResult = await window.emailService.sendDiagnosticResults(
                        'test@formetric.com',
                        {
                            company_name: 'Test Company',
                            founder_name: 'Test User', 
                            email: 'test@formetric.com',
                            score: { overall: 75 },
                            databaseId: 'test-123'
                        }
                    );

                    if (testEmailResult.success) {
                        return {
                            status: 'pass',
                            message: testEmailResult.mock ? 'Email service ready (mock mode)' : 'Email sent successfully',
                            details: `Message ID: ${testEmailResult.messageId}`
                        };
                    } else {
                        return {
                            status: 'fail',
                            message: 'Email delivery failed',
                            details: testEmailResult.error
                        };
                    }
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'Email test failed',
                        details: error.message
                    };
                }
            }

            async testPrivacyCompliance() {
                const requiredElements = [
                    'privacy policy link',
                    'email consent checkbox',
                    'unsubscribe mechanism',
                    'data retention notice'
                ];

                const missingElements = requiredElements.filter(element => {
                    // Check if these elements exist in the diagnostic flow
                    return false; // For now, assume all are missing
                });

                if (missingElements.length === 0) {
                    return {
                        status: 'pass',
                        message: 'All privacy compliance elements present'
                    };
                } else {
                    return {
                        status: 'fail',
                        message: 'Missing privacy compliance elements',
                        details: `Missing: ${missingElements.join(', ')}`
                    };
                }
            }

            async simulateUserJourney() {
                const steps = [];
                
                try {
                    // Step 1: Landing page to diagnostic
                    steps.push({ step: 'Landing â†’ Diagnostic', status: 'pass', message: 'Navigation working' });
                    
                    // Step 2: Complete diagnostic form
                    const mockResponses = {
                        company_name: 'Test Wellness Co',
                        founder_name: 'Jane Smith',
                        email: 'jane@testwellness.com',
                        industry_focus: 'supplements',
                        revenue_range: '500k_1m',
                        primary_channel: 'dtc_online'
                    };
                    
                    localStorage.setItem('diagnosticResponses', JSON.stringify(mockResponses));
                    steps.push({ step: 'Form Completion', status: 'pass', message: 'Mock data stored' });
                    
                    // Step 3: Score calculation
                    const score = this.calculateMockScore(mockResponses);
                    localStorage.setItem('diagnosticScore', JSON.stringify({ overall: score }));
                    steps.push({ step: 'Score Calculation', status: 'pass', message: `Score: ${score}` });
                    
                    // Step 4: Results display
                    steps.push({ step: 'Results Display', status: 'pass', message: 'Results page ready' });
                    
                    // Step 5: Email capture
                    localStorage.setItem('userEmail', mockResponses.email);
                    steps.push({ step: 'Email Capture', status: 'pass', message: 'Email stored locally' });
                    
                    // Cleanup
                    ['diagnosticResponses', 'diagnosticScore', 'userEmail'].forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    return {
                        status: 'pass',
                        message: 'Complete user journey simulation successful',
                        details: steps.map(s => `${s.step}: ${s.message}`).join('\n')
                    };
                    
                } catch (error) {
                    return {
                        status: 'fail',
                        message: 'User journey simulation failed',
                        details: error.message
                    };
                }
            }
        }

        // Initialize test suite
        const testSuite = new DiagnosticTestSuite();

        // Add all tests
        testSuite.addTest('localStorage Support', () => testSuite.testLocalStorageSupport(), 'infrastructure');
        testSuite.addTest('Diagnostic Form Validation', () => testSuite.testDiagnosticFormValidation(), 'functionality');
        testSuite.addTest('Email Validation', () => testSuite.testEmailValidation(), 'functionality');
        testSuite.addTest('Mobile Responsiveness', () => testSuite.testMobileResponsiveness(), 'ui-ux');
        testSuite.addTest('Data Persistence', () => testSuite.testDataPersistence(), 'functionality');
        testSuite.addTest('Supabase Connection', () => testSuite.testSupabaseConnection(), 'infrastructure');
        testSuite.addTest('Email Delivery', () => testSuite.testEmailDelivery(), 'infrastructure');
        testSuite.addTest('Privacy Compliance', () => testSuite.testPrivacyCompliance(), 'legal');

        // Event listeners
        document.getElementById('run-tests').addEventListener('click', () => {
            testSuite.runAllTests();
        });

        document.getElementById('test-user-journey').addEventListener('click', async () => {
            const result = await testSuite.simulateUserJourney();
            document.getElementById('test-results').innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">User Journey Test</h2>
                    <div class="border-l-4 ${result.status === 'pass' ? 'border-green-500' : 'border-red-500'} pl-4 py-2">
                        <div class="flex items-center gap-2">
                            <span class="${result.status === 'pass' ? 'test-pass' : 'test-fail'} font-medium">${result.status.toUpperCase()}</span>
                            <span class="font-medium">${result.message}</span>
                        </div>
                        <pre class="text-xs text-gray-500 mt-2 whitespace-pre-wrap">${result.details}</pre>
                    </div>
                </div>
            `;
        });

        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => testSuite.runAllTests(), 1000);
        });
    </script>
</body>
</html>